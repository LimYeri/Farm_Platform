{% load static %} {% load custom %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>document</title>
    <link
      rel="stylesheet"
      href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
      integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="{% static '/css/wishlist.css' %}" />
  </head>

  <body>
    <form
      name="orderform"
      id="orderform"
      method="post"
      class="orderform"
      action="/Page"
      onsubmit="return false;"
    >
      <h2 style="text-align: center; padding-top: 20px">
        ğŸ¥¦ {{user.first_name}} ë‹˜ì´ ì°œí•œ ìƒí’ˆ ëª©ë¡
      </h2>
      <div class="bigtext right-align sumcount" id="sum_p_num">
        ì°œí•œ ìƒí’ˆê°¯ìˆ˜: {{ products|length }}
      </div>
      <div class="basketdiv" id="basket">
        <div class="row head">
          <div class="subdiv">
            <!-- <div class="check">ì„ íƒ</div> -->
            <div class="img">ì´ë¯¸ì§€</div>
            <div class="pname">ìƒí’ˆëª…</div>
          </div>
          <div class="subdiv">
            <div class="basketprice">ê°€ê²©(ì›)</div>
            <div class="num">íŒë§¤ì</div>
          </div>
          <div class="subdiv">
            <div class="basketcmd">ì±„íŒ…</div>
          </div>
          <div class="split"></div>
        </div>
        {% for product in products %}
        <div class="row data">
          <div
            class="subdiv"
            onclick="location.href='/tran/list/{{product.pk}}';"
          >
            <!-- <div class="check"><input type="checkbox" name="buy" value="260" checked=""
                        onclick="javascript:basket.checkItem();">&nbsp;</div> -->
            <div class="img">
              <img src="{{product.image.url}}" width="45" />
            </div>
            <div class="pname">
              <span
                style="
                  text-overflow: ellipsis;
                  margin-left: 30%;
                  margin-right: 30%;
                "
                >{{ product.productname }}</span
              >
            </div>
          </div>
          <div class="subdiv">
            <div class="basketprice">
              <input
                type="hidden"
                name="p_price"
                id="p_price1"
                class="p_price"
                value="20000"
              />{{ product.price }}
            </div>
            <div class="num">
              <input
                type="hidden"
                name="p_price"
                id="p_price1"
                class="p_price"
              />{{ product.seller.first_name }}
            </div>
          </div>
          <div class="subdiv">
            <div class="basketcmd">
              <a href="/chat/{{product.pk}}" class="abutton">ì±„íŒ…</a>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- <div class="right-align basketrowcmd">
            <a href="javascript:void(0)" class="abutton" onclick="javascript:basket.delCheckedItem();">ì„ íƒ ì¢‹ì•„ìš” ì·¨ì†Œ</a>
        </div> -->

      <!-- <div class="bigtext right-align sumcount" id="sum_p_num">ìƒí’ˆê°¯ìˆ˜:</div> -->
    </form>

    <script>
      let basket = {
        totalCount: 0,
        totalPrice: 0,
        //ì²´í¬í•œ ì¥ë°”êµ¬ë‹ˆ ìƒí’ˆ ë¹„ìš°ê¸°
        delCheckedItem: function () {
          document
            .querySelectorAll("input[name=buy]:checked")
            .forEach(function (item) {
              item.parentElement.parentElement.parentElement.remove();
            });
          //AJAX ì„œë²„ ì—…ë°ì´íŠ¸ ì „ì†¡

          //ì „ì†¡ ì²˜ë¦¬ ê²°ê³¼ê°€ ì„±ê³µì´ë©´
          this.reCalc();
          this.updateUI();
        },
        //ì¥ë°”êµ¬ë‹ˆ ì „ì²´ ë¹„ìš°ê¸°
        delAllItem: function () {
          document.querySelectorAll(".row.data").forEach(function (item) {
            item.remove();
          });
          //AJAX ì„œë²„ ì—…ë°ì´íŠ¸ ì „ì†¡

          //ì „ì†¡ ì²˜ë¦¬ ê²°ê³¼ê°€ ì„±ê³µì´ë©´
          this.totalCount = 0;
          this.totalPrice = 0;
          this.reCalc();
          this.updateUI();
        },
        //ì¬ê³„ì‚°
        reCalc: function () {
          this.totalCount = 0;
          this.totalPrice = 0;
          document.querySelectorAll(".p_num").forEach(function (item) {
            if (
              item.parentElement.parentElement.parentElement
                .previousElementSibling.firstElementChild.firstElementChild
                .checked == true
            ) {
              var count = parseInt(item.getAttribute("value"));
              this.totalCount += count;
              var price =
                item.parentElement.parentElement.previousElementSibling.firstElementChild.getAttribute(
                  "value"
                );
              this.totalPrice += count * price;
            }
          }, this); // forEach 2ë²ˆì§¸ íŒŒë¼ë©”í„°ë¡œ ê°ì²´ë¥¼ ë„˜ê²¨ì„œ this ê°€ ê°ì²´ë¦¬í„°ëŸ´ì„ ê°€ë¦¬í‚¤ë„ë¡ í•¨. - thisArg
        },
        //í™”ë©´ ì—…ë°ì´íŠ¸
        updateUI: function () {
          document.querySelector("#sum_p_num").textContent =
            "ìƒí’ˆê°¯ìˆ˜: " + this.totalCount.formatNumber() + "ê°œ";
          document.querySelector("#sum_p_price").textContent =
            "í•©ê³„ê¸ˆì•¡: " + this.totalPrice.formatNumber() + "ì›";
        },
        //ê°œë³„ ìˆ˜ëŸ‰ ë³€ê²½
        changePNum: function (pos) {
          var item = document.querySelector("input[name=p_num" + pos + "]");
          var p_num = parseInt(item.getAttribute("value"));
          var newval = event.target.classList.contains("up")
            ? p_num + 1
            : event.target.classList.contains("down")
            ? p_num - 1
            : event.target.value;

          if (parseInt(newval) < 1 || parseInt(newval) > 99) {
            return false;
          }

          item.setAttribute("value", newval);
          item.value = newval;

          var price =
            item.parentElement.parentElement.previousElementSibling.firstElementChild.getAttribute(
              "value"
            );
          item.parentElement.parentElement.nextElementSibling.textContent =
            (newval * price).formatNumber() + "ì›";
          //AJAX ì—…ë°ì´íŠ¸ ì „ì†¡

          //ì „ì†¡ ì²˜ë¦¬ ê²°ê³¼ê°€ ì„±ê³µì´ë©´
          this.reCalc();
          this.updateUI();
        },
        checkItem: function () {
          this.reCalc();
          this.updateUI();
        },
        delItem: function () {
          event.target.parentElement.parentElement.parentElement.remove();
          this.reCalc();
          this.updateUI();
        },
      };

      // ìˆ«ì 3ìë¦¬ ì½¤ë§ˆì°ê¸°
      Number.prototype.formatNumber = function () {
        if (this == 0) return 0;
        let regex = /(^[+-]?\d+)(\d{3})/;
        let nstr = this + "";
        while (regex.test(nstr)) nstr = nstr.replace(regex, "$1" + "," + "$2");
        return nstr;
      };
    </script>
  </body>
</html>
